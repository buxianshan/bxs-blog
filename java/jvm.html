<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM笔记 | bxs.ink</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://buxianshan.oss-cn-beijing.aliyuncs.com/favicon.ico">
    <script>var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?40291c62c61f1ce49b021bc0f36df71e";
            if (window.location.hostname !== "localhost") {
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            }
        })();</script>
    <script src="https://www.googletagmanager.com/gtag/js?id=G-F12EYNDHWH" async="true"></script>
    <script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-F12EYNDHWH');</script>
    <meta name="description" content="一些个人理解、笔记和分享">
    
    <link rel="preload" href="/bxs-blog/assets/css/0.styles.4dbfea6c.css" as="style"><link rel="preload" href="/bxs-blog/assets/js/app.7578192e.js" as="script"><link rel="preload" href="/bxs-blog/assets/js/2.573d8f00.js" as="script"><link rel="preload" href="/bxs-blog/assets/js/43.a2766d86.js" as="script"><link rel="preload" href="/bxs-blog/assets/js/10.5b9464ff.js" as="script"><link rel="prefetch" href="/bxs-blog/assets/js/11.7e7abe8e.js"><link rel="prefetch" href="/bxs-blog/assets/js/12.800bd340.js"><link rel="prefetch" href="/bxs-blog/assets/js/13.a3be438e.js"><link rel="prefetch" href="/bxs-blog/assets/js/14.205c07d0.js"><link rel="prefetch" href="/bxs-blog/assets/js/15.ea9c2213.js"><link rel="prefetch" href="/bxs-blog/assets/js/16.b227edaa.js"><link rel="prefetch" href="/bxs-blog/assets/js/17.aae3775f.js"><link rel="prefetch" href="/bxs-blog/assets/js/18.018f7f47.js"><link rel="prefetch" href="/bxs-blog/assets/js/19.37f7adf7.js"><link rel="prefetch" href="/bxs-blog/assets/js/20.57a60a7e.js"><link rel="prefetch" href="/bxs-blog/assets/js/21.cd9c89f5.js"><link rel="prefetch" href="/bxs-blog/assets/js/22.44c562c8.js"><link rel="prefetch" href="/bxs-blog/assets/js/23.9e9b15ef.js"><link rel="prefetch" href="/bxs-blog/assets/js/24.c050ebb3.js"><link rel="prefetch" href="/bxs-blog/assets/js/25.75e890fc.js"><link rel="prefetch" href="/bxs-blog/assets/js/26.fceee696.js"><link rel="prefetch" href="/bxs-blog/assets/js/27.4348131b.js"><link rel="prefetch" href="/bxs-blog/assets/js/28.9fe80779.js"><link rel="prefetch" href="/bxs-blog/assets/js/29.cfd9a0ec.js"><link rel="prefetch" href="/bxs-blog/assets/js/3.29cf0858.js"><link rel="prefetch" href="/bxs-blog/assets/js/30.ef20ff5c.js"><link rel="prefetch" href="/bxs-blog/assets/js/31.04d1fadd.js"><link rel="prefetch" href="/bxs-blog/assets/js/32.2c584994.js"><link rel="prefetch" href="/bxs-blog/assets/js/33.dfe0f8bb.js"><link rel="prefetch" href="/bxs-blog/assets/js/34.ea7b8f74.js"><link rel="prefetch" href="/bxs-blog/assets/js/35.1d8a3185.js"><link rel="prefetch" href="/bxs-blog/assets/js/36.d7a213d2.js"><link rel="prefetch" href="/bxs-blog/assets/js/37.c888b3ff.js"><link rel="prefetch" href="/bxs-blog/assets/js/38.8e1844b4.js"><link rel="prefetch" href="/bxs-blog/assets/js/39.8ee4e454.js"><link rel="prefetch" href="/bxs-blog/assets/js/4.8c40fe05.js"><link rel="prefetch" href="/bxs-blog/assets/js/40.d4b97474.js"><link rel="prefetch" href="/bxs-blog/assets/js/41.fbd946cd.js"><link rel="prefetch" href="/bxs-blog/assets/js/42.a2c1e17a.js"><link rel="prefetch" href="/bxs-blog/assets/js/44.7f3a4d37.js"><link rel="prefetch" href="/bxs-blog/assets/js/45.670957f4.js"><link rel="prefetch" href="/bxs-blog/assets/js/46.5bbcd2be.js"><link rel="prefetch" href="/bxs-blog/assets/js/47.4b0f5480.js"><link rel="prefetch" href="/bxs-blog/assets/js/48.1e38cc47.js"><link rel="prefetch" href="/bxs-blog/assets/js/49.cdf6f2bc.js"><link rel="prefetch" href="/bxs-blog/assets/js/5.7f407ead.js"><link rel="prefetch" href="/bxs-blog/assets/js/50.1acb4ecb.js"><link rel="prefetch" href="/bxs-blog/assets/js/51.dd6a38d1.js"><link rel="prefetch" href="/bxs-blog/assets/js/52.8bbcd01b.js"><link rel="prefetch" href="/bxs-blog/assets/js/53.f9018418.js"><link rel="prefetch" href="/bxs-blog/assets/js/54.af1c999f.js"><link rel="prefetch" href="/bxs-blog/assets/js/55.1e387a3c.js"><link rel="prefetch" href="/bxs-blog/assets/js/56.8bb1b9ce.js"><link rel="prefetch" href="/bxs-blog/assets/js/57.d911b57f.js"><link rel="prefetch" href="/bxs-blog/assets/js/58.cb5af35f.js"><link rel="prefetch" href="/bxs-blog/assets/js/59.57048bb0.js"><link rel="prefetch" href="/bxs-blog/assets/js/6.8b21b09c.js"><link rel="prefetch" href="/bxs-blog/assets/js/60.ca986b4b.js"><link rel="prefetch" href="/bxs-blog/assets/js/61.fc985e1b.js"><link rel="prefetch" href="/bxs-blog/assets/js/62.9c66319f.js"><link rel="prefetch" href="/bxs-blog/assets/js/63.4f88ab80.js"><link rel="prefetch" href="/bxs-blog/assets/js/64.82caa3df.js"><link rel="prefetch" href="/bxs-blog/assets/js/65.1616a03c.js"><link rel="prefetch" href="/bxs-blog/assets/js/66.416ba54f.js"><link rel="prefetch" href="/bxs-blog/assets/js/67.55ffdf2b.js"><link rel="prefetch" href="/bxs-blog/assets/js/68.81d35d3c.js"><link rel="prefetch" href="/bxs-blog/assets/js/7.0c43d222.js"><link rel="prefetch" href="/bxs-blog/assets/js/8.4289f47a.js"><link rel="prefetch" href="/bxs-blog/assets/js/9.9f70835a.js">
    <link rel="stylesheet" href="/bxs-blog/assets/css/0.styles.4dbfea6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bxs-blog/" class="home-link router-link-active"><!----> <span class="site-name">bxs.ink</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bxs-blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python Menu" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python Menu" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/python/introduction.html" class="nav-link">
  简介
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/snippets.html" class="nav-link">
  常用代码片段
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/class.html" class="nav-link">
  Python 面向对象
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/multithread.html" class="nav-link">
  Python 多线程
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/console-arguments.html" class="nav-link">
  Python 命令行传参
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/with.html" class="nav-link">
  with 语句
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/build-package.html" class="nav-link">
  打包项目到PyPI
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/pyc.html" class="nav-link">
  pyc文件
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/name-style.html" class="nav-link">
  命名风格建议
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/pycharm-generate-doc-string.html" class="nav-link">
  Pycharm 生成文档字符串
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/zen.html" class="nav-link">
  The Zen of Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java Menu" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java Menu" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/java/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/java/jvm.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Design Patterns Menu" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Design Patterns Menu" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/introduction.html" class="nav-link">
  简介
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/singleton.html" class="nav-link">
  单例模式
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/visitor.html" class="nav-link">
  访问者模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux Menu" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux Menu" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/commands-log.html" class="nav-link">
  常用命令记录
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/custom-commands.html" class="nav-link">
  重写/自定义命令
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/shell.html" class="nav-link">
  Shell类型
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/esxi.html" class="nav-link">
  ESXi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front-end Menu" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Front-end Menu" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/html.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/js.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/nodejs.html" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/ajax.html" class="nav-link">
  AJAX
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/experience.html" class="nav-link">
  问题记录
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Docker" class="dropdown-title"><span class="title">Docker</span> <span class="arrow down"></span></button> <button type="button" aria-label="Docker" class="mobile-dropdown-title"><span class="title">Docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/notes.html" class="nav-link">
  基础笔记
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/experience.html" class="nav-link">
  问题记录
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/docker-compose.html" class="nav-link">
  docker-compose
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Debug" class="dropdown-title"><span class="title">Debug</span> <span class="arrow down"></span></button> <button type="button" aria-label="Debug" class="mobile-dropdown-title"><span class="title">Debug</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/dll-load-failed-while-importing-cv2.html" class="nav-link">
  DLL load failed while importing cv2
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/linux-java-environment-variables.html" class="nav-link">
  linux服务器java环境变量问题
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/port-already-in-use.html" class="nav-link">
  端口被占用
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools Menu" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools Menu" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/tools-i-use.html" class="nav-link">
  常用工具
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/sourcetree.html" class="nav-link">
  Sourcetree
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/typora.html" class="nav-link">
  Typora
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/microsoft-rdp.html" class="nav-link">
  微软RDP优化
</a></li><li class="dropdown-item"><!----> <a href="https://icon.bxs.ink/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Get Website Icon
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/vimium.html" class="nav-link">
  Chrome插件-Vimium
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/time.html" class="nav-link">
  时间
</a></li></ul></div></div><div class="nav-item"><a href="/bxs-blog/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/bxs-blog/collections/" class="nav-link">
  收藏
</a></div><div class="nav-item"><a href="/bxs-blog/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/buxianshan/bxs-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bxs-blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python Menu" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python Menu" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/python/introduction.html" class="nav-link">
  简介
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/snippets.html" class="nav-link">
  常用代码片段
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/class.html" class="nav-link">
  Python 面向对象
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/multithread.html" class="nav-link">
  Python 多线程
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/console-arguments.html" class="nav-link">
  Python 命令行传参
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/with.html" class="nav-link">
  with 语句
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/build-package.html" class="nav-link">
  打包项目到PyPI
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/pyc.html" class="nav-link">
  pyc文件
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/name-style.html" class="nav-link">
  命名风格建议
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/pycharm-generate-doc-string.html" class="nav-link">
  Pycharm 生成文档字符串
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/python/zen.html" class="nav-link">
  The Zen of Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java Menu" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java Menu" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/java/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/java/jvm.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Design Patterns Menu" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="Design Patterns Menu" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/introduction.html" class="nav-link">
  简介
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/singleton.html" class="nav-link">
  单例模式
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/design-patterns/visitor.html" class="nav-link">
  访问者模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux Menu" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux Menu" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/commands-log.html" class="nav-link">
  常用命令记录
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/custom-commands.html" class="nav-link">
  重写/自定义命令
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/shell.html" class="nav-link">
  Shell类型
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/linux/esxi.html" class="nav-link">
  ESXi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front-end Menu" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Front-end Menu" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/html.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/js.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/nodejs.html" class="nav-link">
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/ajax.html" class="nav-link">
  AJAX
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/front-end/experience.html" class="nav-link">
  问题记录
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Docker" class="dropdown-title"><span class="title">Docker</span> <span class="arrow down"></span></button> <button type="button" aria-label="Docker" class="mobile-dropdown-title"><span class="title">Docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/notes.html" class="nav-link">
  基础笔记
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/experience.html" class="nav-link">
  问题记录
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/docker/docker-compose.html" class="nav-link">
  docker-compose
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Debug" class="dropdown-title"><span class="title">Debug</span> <span class="arrow down"></span></button> <button type="button" aria-label="Debug" class="mobile-dropdown-title"><span class="title">Debug</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/dll-load-failed-while-importing-cv2.html" class="nav-link">
  DLL load failed while importing cv2
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/linux-java-environment-variables.html" class="nav-link">
  linux服务器java环境变量问题
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/debug/port-already-in-use.html" class="nav-link">
  端口被占用
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools Menu" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools Menu" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/tools-i-use.html" class="nav-link">
  常用工具
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/sourcetree.html" class="nav-link">
  Sourcetree
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/typora.html" class="nav-link">
  Typora
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/microsoft-rdp.html" class="nav-link">
  微软RDP优化
</a></li><li class="dropdown-item"><!----> <a href="https://icon.bxs.ink/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Get Website Icon
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/vimium.html" class="nav-link">
  Chrome插件-Vimium
</a></li><li class="dropdown-item"><!----> <a href="/bxs-blog/tools/time.html" class="nav-link">
  时间
</a></li></ul></div></div><div class="nav-item"><a href="/bxs-blog/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/bxs-blog/collections/" class="nav-link">
  收藏
</a></div><div class="nav-item"><a href="/bxs-blog/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/buxianshan/bxs-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bxs-blog/java/jvm.html#jdk、jre、jvm-之间的关系" class="sidebar-link">JDK、JRE、JVM 之间的关系</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bxs-blog/java/jvm.html#常见的编程语言类型" class="sidebar-link">常见的编程语言类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#高级语言分类" class="sidebar-link">高级语言分类</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#关于跨平台" class="sidebar-link">关于跨平台</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#关于运行时-runtime-与虚拟机-vm" class="sidebar-link">关于运行时（Runtime）与虚拟机（VM）</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#关于内存管理和垃圾回收-gc" class="sidebar-link">关于内存管理和垃圾回收（GC）</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#字节码技术" class="sidebar-link">字节码技术</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bxs-blog/java/jvm.html#类加载器" class="sidebar-link">类加载器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#类的生命周期和加载过程" class="sidebar-link">类的生命周期和加载过程</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#类加载时机" class="sidebar-link">类加载时机</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#内存模型" class="sidebar-link">内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jvm-内存结构" class="sidebar-link">JVM 内存结构</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#栈内存的结构" class="sidebar-link">栈内存的结构</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#堆内存的结构" class="sidebar-link">堆内存的结构</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jmm-简介" class="sidebar-link">JMM 简介</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#jvm-启动参数" class="sidebar-link">JVM 启动参数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#agent-相关的选项" class="sidebar-link">Agent 相关的选项</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jvm-运行模式" class="sidebar-link">JVM 运行模式</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#设置堆内存" class="sidebar-link">设置堆内存</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#配置多少-xmx-合适" class="sidebar-link">配置多少 xmx 合适</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#xmx-和-xms-是不是要配置成一致的" class="sidebar-link">xmx 和 xms 是不是要配置成一致的</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#gc-日志相关的参数" class="sidebar-link">GC 日志相关的参数</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#jdk-内置命令行工具" class="sidebar-link">JDK 内置命令行工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jdk-内置的开发工具" class="sidebar-link">JDK 内置的开发工具</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#命令行诊断和分析工具" class="sidebar-link">命令行诊断和分析工具</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jps" class="sidebar-link">jps</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jstat" class="sidebar-link">jstat</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jmap" class="sidebar-link">jmap</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jcmd" class="sidebar-link">jcmd</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jstack" class="sidebar-link">jstack</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#jdk-内置图形界面工具" class="sidebar-link">JDK 内置图形界面工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jconsole" class="sidebar-link">JConsole</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jvisualvm" class="sidebar-link">JVisualVM</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jmc" class="sidebar-link">JMC</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#java-平台调试体系" class="sidebar-link">Java 平台调试体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#服务端-jvm-配置" class="sidebar-link">服务端 JVM 配置</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jdb" class="sidebar-link">JDB</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#idea-中使用远程调试" class="sidebar-link">IDEA 中使用远程调试</a></li><li class="sidebar-sub-header"><a href="/bxs-blog/java/jvm.html#jdwp-协议规范" class="sidebar-link">JDWP 协议规范</a></li></ul></li><li><a href="/bxs-blog/java/jvm.html#jmx-与相关工具" class="sidebar-link">JMX 与相关工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bxs-blog/java/jvm.html#未完待续" class="sidebar-link">未完待续……</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 align="center">JVM笔记</h1> <div class="reset-content-width" data-v-456c0cd2></div> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>本文大部分内容摘抄自<a href="https://gitbook.cn/gitchat/column/5de76cc38d374b7721a15cec" target="_blank" rel="noopener noreferrer">《JVM核心技术32讲》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，感谢作者。</p></div> <h2 id="jdk、jre、jvm-之间的关系"><a href="#jdk、jre、jvm-之间的关系" class="header-anchor">#</a> JDK、JRE、JVM 之间的关系</h2> <p><strong>JDK</strong></p> <p>JDK（Java Development Kit） 是用于开发 Java 应用程序的软件开发工具集合，包括了 Java 运行时的环境（JRE）、解释器（Java）、编译器（javac）、Java 归档（jar）、文档生成器（Javadoc）等工具。简单的说我们要开发 Java 程序，就需要安装某个版本的 JDK 工具包。</p> <p><strong>JRE</strong></p> <p>JRE（Java Runtime Enviroment ）提供 Java 应用程序执行时所需的环境，由 Java 虚拟机（JVM）、核心类、支持文件等组成。简单的说，我们要是想在某个机器上运行 Java 程序，可以安装 JDK，也可以只安装 JRE，后者体积比较小。</p> <p><strong>JVM</strong></p> <p>Java Virtual Machine（Java 虚拟机）有三层含义，分别是：</p> <ul><li>JVM规范要求；</li> <li>满足 JVM 规范要求的一种具体实现（一种计算机程序）；</li> <li>一个 JVM 运行实例，在命令提示符下编写 Java 命令以运行 Java 类时，都会创建一个 JVM 实例，我们下面如果只记到 JVM 则指的是这个含义；如果我们带上了某种 JVM 的名称，比如说是 Zing JVM，则表示上面第二种含义。</li></ul> <p><strong>JDK 与 JRE、JVM 之间的关系</strong></p> <p>就范围来说，JDK &gt; JRE &gt; JVM：</p> <ul><li>JDK = JRE + 开发工具</li> <li>JRE = JVM + 类库</li></ul> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220319200343678.png" alt="image-20220319200343678"></p> <p>三者在开发运行 Java 程序时的交互关系：</p> <p>简单的说，就是通过 JDK 开发的程序，编译以后，可以打包分发给其他装有 JRE 的机器上去运行。而运行的程序，则是通过 Java 命令启动的一个 JVM 实例，代码逻辑的执行都运行在这个 JVM 实例上。</p> <p>Java 程序的开发运行过程为：</p> <p>我们利用 JDK （调用 Java API）开发 Java 程序，编译成字节码或者打包程序。然后可以用 JRE 则启动一个 JVM 实例，加载、验证、执行 Java 字节码以及依赖库，运行 Java 程序。而 JVM 将程序和依赖库的 Java 字节码解析并变成本地代码执行，产生结果。</p> <h2 id="常见的编程语言类型"><a href="#常见的编程语言类型" class="header-anchor">#</a> 常见的编程语言类型</h2> <p>从底向上划分为最基本的三大类：机器语言、汇编语言、高级语言。</p> <h3 id="高级语言分类"><a href="#高级语言分类" class="header-anchor">#</a> 高级语言分类</h3> <p>如果按照有没有虚拟机来划分，高级编程语言可分为两类：</p> <ul><li>有虚拟机：Java，Lua，Ruby，部分 JavaScript 的实现等等</li> <li>无虚拟机：C，C++，C#，Golang，以及大部分常见的编程语言</li></ul> <p>如果按照变量是不是有确定的类型，还是类型可以随意变化来划分，高级编程语言可以分为：</p> <ul><li>静态类型：Java，C，C++ 等等</li> <li>动态类型：所有脚本类型的语言</li></ul> <p>如果按照是编译执行，还是解释执行，可以分为：</p> <ul><li>编译执行：C，C++，Golang，Rust，C#，Java，Scala，Clojure，Kotlin，Swift 等等</li> <li>解释执行：JavaScript 的部分实现和 NodeJS，Python，Perl，Ruby 等等</li></ul> <p>这里面，C# 和 Java 都是编译后生成了一种中间类型的目标代码（类似汇编），但不是汇编或机器码，在C#中称为 <code>微软中间语言</code>（MSIL），在 Java 里叫做 <code>Java 字节码</code>（Java bytecode）。</p> <p>此外，我们还可以按照语言特点分类：</p> <ul><li>面向过程：C，Basic，Pascal，Fortran 等等；</li> <li>面向对象：C++，Java，Ruby，Smalltalk 等等；</li> <li>函数式编程：LISP、Haskell、Erlang、OCaml、Clojure、F# 等等。</li></ul> <h3 id="关于跨平台"><a href="#关于跨平台" class="header-anchor">#</a> 关于跨平台</h3> <p>1、典型的源码跨平台（C++）：</p> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220319201014121.png" alt="image-20220319201014121"></p> <p>2、典型的二进制跨平台（Java 字节码）：</p> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220319201041220.png" alt="image-20220319201041220"></p> <p>C++ 里我们需要把一份源码，在不同平台上分别编译，生成这个平台相关的二进制可执行文件，然后才能在相应的平台上运行。 这样就需要在各个平台都有开发工具和编译器，而且在各个平台所依赖的开发库都需要是一致或兼容的。 这一点在过去的年代里非常痛苦，被戏称为 “依赖地狱”。</p> <p>C++ 的口号是“一次编写，到处（不同平台）编译”，但实际情况上是一编译就报错，变成了 “一次编写，到处调试，到处找依赖、改配置”。 大家可以想象，你编译一份代码，发现缺了几十个依赖，到处找还找不到，或者找到了又跟本地已有的版本不兼容，这是一件怎样令人绝望的事情。</p> <p>而 Java 语言通过虚拟机技术率先解决了这个难题。 源码只需要编译一次，然后把编译后的 class 文件或 jar 包，部署到不同平台，就可以直接通过安装在这些系统中的 JVM 上面执行。 同时可以把依赖库（jar 文件）一起复制到目标机器，慢慢地又有了可以在各个平台都直接使用的 Maven 中央库（类似于 linux 里的 yum 或 apt-get 源，macos 里的 homebrew，现代的各种编程语言一般都有了这种包依赖管理机制：python 的 pip，dotnet 的 nuget，NodeJS 的 npm，golang 的 dep，rust 的 cargo 等等）。这样就实现了让同一个应用程序在不同的平台上直接运行的能力。</p> <h3 id="关于运行时-runtime-与虚拟机-vm"><a href="#关于运行时-runtime-与虚拟机-vm" class="header-anchor">#</a> 关于运行时（Runtime）与虚拟机（VM）</h3> <p>简单的说 JRE 就是 Java 的运行时，包括虚拟机和相关的库等资源。</p> <p>可以说运行时提供了程序运行的基本环境，JVM 在启动时需要加载所有运行时的核心库等资源，然后再加载我们的应用程序字节码，才能让应用程序字节码运行在 JVM 这个容器里。</p> <h3 id="关于内存管理和垃圾回收-gc"><a href="#关于内存管理和垃圾回收-gc" class="header-anchor">#</a> 关于内存管理和垃圾回收（GC）</h3> <ul><li>C/C++ 完全相信而且惯着程序员，让大家自行管理内存，所以可以编写很自由的代码，但一个不小心就会造成内存泄漏等问题导致程序崩溃。</li> <li>Java/Golang 完全不相信程序员，但也惯着程序员。所有的内存生命周期都由 JVM 运行时统一管理。 在绝大部分场景下，你可以非常自由的写代码，而且不用关心内存到底是什么情况。 内存使用有问题的时候，我们可以通过 JVM 来信息相关的分析诊断和调整。 这也是本课程的目标。</li> <li>Rust 语言选择既不相信程序员，也不惯着程序员。 让你在写代码的时候，必须清楚明白的用 Rust 的规则管理好你的变量，好让机器能明白高效地分析和管理内存。 但是这样会导致代码不利于人的理解，写代码很不自由，学习成本也很高。</li></ul> <h2 id="字节码技术"><a href="#字节码技术" class="header-anchor">#</a> 字节码技术</h2> <p>Java 中的字节码，英文名为 <code>bytecode</code>, 是 Java 代码编译后的中间代码格式。JVM 需要读取并解析字节码才能执行相应的任务。</p> <p><code>Java bytecode</code> 由单字节(<code>byte</code>)的指令组成，理论上最多支持 <code>256</code> 个操作码(opcode)。实际上 Java 只使用了 200 左右的操作码， 还有一些操作码则保留给调试操作。</p> <h2 id="类加载器"><a href="#类加载器" class="header-anchor">#</a> 类加载器</h2> <p>我们可以用 Java 命令指定主启动类，或者是 Jar 包，通过约定好的机制，JVM 就会自动去加载对应的字节码（可能是 class 文件，也可能是 Jar 包）。</p> <p>按照 Java 语言规范和 Java 虚拟机规范的定义, 我们用 “<code>类加载</code>(Class Loading)” 来表示: 将 class/interface 名称映射为 Class 对象的一整个过程。 这个过程还可以划分为更具体的阶段: 加载，链接和初始化(loading, linking and initializing)。</p> <h3 id="类的生命周期和加载过程"><a href="#类的生命周期和加载过程" class="header-anchor">#</a> 类的生命周期和加载过程</h3> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220319202336717.png" alt="image-20220319202336717"></p> <p>一个类在 JVM 里的生命周期有 7 个阶段，分别是加载（Loading）、验证（Verification）、准备（Preparation）、解析（Resolution）、初始化（Initialization）、使用（Using）、卸载（Unloading）。</p> <p>其中前五个部分（加载，验证，准备，解析，初始化）统称为类加载。</p> <p>JVM 规范明确规定, 必须在类的首次“主动使用”时才能执行类初始化。</p> <p>初始化的过程包括执行：</p> <ul><li>类构造器方法</li> <li>static 静态变量赋值语句</li> <li>static 静态代码块</li></ul> <h3 id="类加载时机"><a href="#类加载时机" class="header-anchor">#</a> 类加载时机</h3> <p>JVM 规范枚举了下述多种触发情况：</p> <ul><li>当虚拟机启动时，初始化用户指定的主类，就是启动执行的 main 方法所在的类；</li> <li>当遇到用以新建目标类实例的 new 指令时，初始化 new 指令的目标类，就是 new 一个类的时候要初始化；</li> <li>当遇到调用静态方法的指令时，初始化该静态方法所在的类；</li> <li>当遇到访问静态字段的指令时，初始化该静态字段所在的类；</li> <li>子类的初始化会触发父类的初始化；</li> <li>如果一个接口定义了 default 方法，那么直接实现或者间接实现该接口的类的初始化，会触发该接口的初始化；</li> <li>使用反射 API 对某个类进行反射调用时，初始化这个类，其实跟前面一样，反射调用要么是已经有实例了，要么是静态方法，都需要初始化；</li> <li>当初次调用 MethodHandle 实例时，初始化该 MethodHandle 指向的方法所在的类。</li></ul> <p>同时以下几种情况不会执行类初始化：</p> <ul><li>通过子类引用父类的静态字段，只会触发父类的初始化，而不会触发子类的初始化。</li> <li>定义对象数组，不会触发该类的初始化。</li> <li>常量在编译期间会存入调用类的常量池中，本质上并没有直接引用定义常量的类，不会触发定义常量所在的类。</li> <li>通过类名获取 Class 对象，不会触发类的初始化，Hello.class 不会让 Hello 类初始化。</li> <li>通过 Class.forName 加载指定类时，如果指定参数 initialize 为 false 时，也不会触发类初始化，其实这个参数是告诉虚拟机，是否要对类进行初始化。Class.forName(“jvm.Hello”)默认会加载 Hello 类。</li> <li>通过 ClassLoader 默认的 loadClass 方法，也不会触发初始化动作（加载了，但是不初始化）。</li></ul> <p>示例: 诸如 Class.forName(), classLoader.loadClass() 等 Java API, 反射API, 以及 JNI_FindClass 都可以启动类加载。 JVM 本身也会进行类加载。 比如在 JVM 启动时加载核心类，java.lang.Object, java.lang.Thread 等等。</p> <h2 id="内存模型"><a href="#内存模型" class="header-anchor">#</a> 内存模型</h2> <p>JVM 是一个完整的计算机模型，所以自然就需要有对应的内存模型，这个模型被称为 “<code>Java 内存模型</code>”，对应的英文是“<code>Java Memory Model</code>”，简称 <code>JMM</code>。</p> <h3 id="jvm-内存结构"><a href="#jvm-内存结构" class="header-anchor">#</a> JVM 内存结构</h3> <p>JVM 内部使用的 Java 内存模型， 在逻辑上将内存划分为 <code>线程栈</code>（thread stacks）和<code>堆内存</code> （heap）两个部分。 如下图所示：</p> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220319202920404.png" alt="image-20220319202920404"></p> <p>JVM 中，每个正在运行的线程，都有自己的线程栈。 线程栈包含了当前正在执行的方法链/调用链上的所有方法的状态信息。</p> <p>所以线程栈又被称为“<code>方法栈</code>”或“<code>调用栈</code>”（call stack）。线程在执行代码时，调用栈中的信息会一直在变化。</p> <p>线程栈里面保存了调用链上正在执行的所有方法中的局部变量。</p> <ul><li>每个线程都只能访问自己的线程栈。</li> <li>每个线程都不能访问(看不见)其他线程的局部变量。</li></ul> <p>即使两个线程正在执行完全相同的代码，但每个线程都会在自己的线程栈内创建对应代码中声明的局部变量。 所以每个线程都有一份自己的局部变量副本。</p> <ul><li>所有原生类型的局部变量都存储在线程栈中，因此对其他线程是不可见的。</li> <li>线程可以将一个原生变量值的副本传给另一个线程，但不能共享原生局部变量本身。</li> <li>堆内存中包含了 Java 代码中创建的所有对象，不管是哪个线程创建的。 其中也涵盖了包装类型（例如<code>Byte</code>，<code>Integer</code>，<code>Long</code>等）。</li> <li>不管是创建一个对象并将其赋值给局部变量， 还是赋值给另一个对象的成员变量， 创建的对象都会被保存到堆内存中。</li></ul> <p>总结：<strong>原始数据类型和对象引用地址在栈上；对象、对象成员与类定义、静态变量在堆上</strong>。</p> <p>堆内存又称为“<code>共享堆</code>”，堆中的所有对象，可以被所有线程访问, 只要他们能拿到对象的引用地址。</p> <ul><li>如果一个线程可以访问某个对象时，也就可以访问该对象的成员变量。</li> <li>如果两个线程同时调用某个对象的同一方法，则它们都可以访问到这个对象的成员变量，但每个线程的局部变量副本是独立的。</li></ul> <p>总结：<strong>虽然各个线程自己使用的局部变量都在自己的栈上，但是大家可以共享堆上的对象，特别地各个不同线程访问同一个对象实例的基础类型的成员变量，会给每个线程一个变量的副本。</strong></p> <h3 id="栈内存的结构"><a href="#栈内存的结构" class="header-anchor">#</a> 栈内存的结构</h3> <p>每启动一个线程，JVM 就会在栈空间栈分配对应的<strong>线程栈</strong>, 比如 1MB 的空间（<code>-Xss1m</code>）。</p> <p>线程执行过程中，一般会有多个方法组成调用栈(Stack Trace), 比如 A 调用 B，B 调用 C……每执行到一个方法，就会创建对应的<strong>栈帧</strong>(Frame)。</p> <p>栈帧是一个逻辑上的概念，具体的大小在一个方法编写完成后基本上就能确定。</p> <p>比如 <code>返回值</code> 需要有一个空间存放，每个<code>局部变量</code>都需要对应的地址空间，此外还有给指令使用的 <code>操作数栈</code>，以及 class 指针(标识这个栈帧对应的是哪个类的方法, 指向非堆里面的 Class 对象）。</p> <h3 id="堆内存的结构"><a href="#堆内存的结构" class="header-anchor">#</a> 堆内存的结构</h3> <p>堆内存是所有线程共用的内存空间，理论上大家都可以访问里面的内容。</p> <p>但 JVM 的具体实现一般会有各种优化。比如将逻辑上的 Java 堆,划分为<code>堆(Heap)</code>和<code>非堆(Non-Heap)</code>两个部分.。这种划分的依据在于，我们编写的 Java 代码，基本上只能使用 Heap 这部分空间，发生内存分配和回收的主要区域也在这部分，所以有一种说法，这里的 Heap 也叫 GC 管理的堆(GC Heap)。</p> <p>GC 理论中有一个重要的思想，叫做分代。 经过研究发现，程序中分配的对象，要么用过就扔，要么就能存活很久很久。因此，JVM 将 Heap 内存分为年轻代（Young generation）和老年代（Old generation, 也叫 Tenured）两部分。</p> <p>Non-Heap 本质上还是 Heap，只是一般不归 GC 管理。</p> <h3 id="jmm-简介"><a href="#jmm-简介" class="header-anchor">#</a> JMM 简介</h3> <p>目前的 JMM 规范对应的是 “<a href="https://jcp.org/en/jsr/detail?id=133" target="_blank" rel="noopener noreferrer">JSR-133. Java Memory Model and Thread Specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>” ，这个规范的部分内容润色之后就成为了《Java语言规范》的 <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.4" target="_blank" rel="noopener noreferrer">$17.4. Memory Model章节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>JMM 定义了一些术语和规定：</p> <ul><li>能被多个线程共享使用的内存称为“<code>共享内存</code>”或“<code>堆内存</code>”。</li> <li>所有的对象(包括内部的实例成员变量)，static 变量，以及数组，都必须存放到堆内存中。</li> <li>局部变量，方法的形参/入参，异常处理语句的入参不允许在线程之间共享，所以不受内存模型的影响。</li> <li>多个线程同时对一个变量访问时【读取/写入】，这时候只要有某个线程执行的是写操作，那么这种现象就称之为“冲突”。</li> <li>可以被其他线程影响或感知的操作，称为线程间的交互行为， 可分为： 读取、写入、同步操作、外部操作等等。 其中同步操作包括：对 volatile 变量的读写，对管程(monitor)的锁定与解锁，线程的起始操作与结尾操作，线程启动和结束等等。 外部操作则是指对线程执行环境之外的操作，比如停止其他线程等等。</li></ul> <p>JMM 规范的是线程间的交互操作，而不管线程内部对局部变量进行的操作。</p> <h2 id="jvm-启动参数"><a href="#jvm-启动参数" class="header-anchor">#</a> JVM 启动参数</h2> <p>JVM 作为一个通用的虚拟机，我们可以通过启动 Java 命令时指定不同的 JVM 参数，让 JVM 调整自己的运行状态和行为，内存管理和垃圾回收的 GC 算法，添加和处理调试和诊断信息等等。</p> <p>直接通过命令行启动 Java 程序的格式为:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>java <span class="token punctuation">[</span>options<span class="token punctuation">]</span> classname <span class="token punctuation">[</span>args<span class="token punctuation">]</span>

java <span class="token punctuation">[</span>options<span class="token punctuation">]</span> -jar filename <span class="token punctuation">[</span>args<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中:</p> <ul><li><code>[options]</code> 部分称为 &quot;JVM 选项&quot;,对应 IDE 中的 VM options, 可用 <code>jps -v</code> 查看。</li> <li><code>[args]</code> 部分是指 &quot;传给main函数的参数&quot;, 对应 IDE 中的 Program arguments, 可用 <code>jps -m</code> 查看。</li></ul> <p>Java 和 JDK 内置的工具，指定参数时都是一个 <code>-</code>，不管是长参数还是短参数。</p> <p>JVM 的启动参数, 从形式上可以简单分为：</p> <ul><li>以<code>-</code>开头为标准参数，所有的 JVM 都要实现这些参数，并且向后兼容。</li> <li>以<code>-X</code>开头为非标准参数， 基本都是传给 JVM 的，默认 JVM 实现这些参数的功能，但是并不保证所有 JVM 实现都满足，且不保证向后兼容。</li> <li>以<code>-XX:</code>开头为非稳定参数, 专门用于控制 JVM 的行为，跟具体的 JVM 实现有关，随时可能会在下个版本取消。</li> <li><code>-XX:+-Flags</code> 形式, <code>+-</code> 是对布尔值进行开关。</li> <li><code>-XX:key=value</code> 形式, 指定某个选项的值。</li></ul> <h3 id="agent-相关的选项"><a href="#agent-相关的选项" class="header-anchor">#</a> Agent 相关的选项</h3> <p>Agent 是 JVM 中的一项黑科技, 可以通过无侵入方式来做很多事情，比如注入 AOP 代码，执行统计等等，权限非常大。</p> <p>设置 agent 的语法如下:</p> <ul><li><code>-agentlib:libname[=options]</code> 启用native方式的agent, 参考 <code>LD_LIBRARY_PATH</code> 路径。</li> <li><code>-agentpath:pathname[=options]</code> 启用native方式的agent。</li> <li><code>-javaagent:jarpath[=options]</code> 启用外部的agent库, 比如 <code>pinpoint.jar</code> 等等。</li> <li><code>-Xnoagent</code> 则是禁用所有 agent。</li></ul> <h3 id="jvm-运行模式"><a href="#jvm-运行模式" class="header-anchor">#</a> JVM 运行模式</h3> <p>JVM 有两种运行模式：</p> <ul><li><code>-server</code>：设置 jvm 使 server 模式，特点是启动速度比较慢，但运行时性能和内存管理效率很高，适用于生产环境。在具有 64 位能力的 jdk 环境下将默认启用该模式，而忽略 -client 参数。</li> <li><code>-client</code> ：JDK1.7 之前在 32 位的 x86 机器上的默认值是 <code>-client</code> 选项。设置 jvm 使用 client 模式，特点是启动速度比较快，但运行时性能和内存管理效率不高，通常用于客户端应用程序或者PC应用开发和调试。</li></ul> <h3 id="设置堆内存"><a href="#设置堆内存" class="header-anchor">#</a> 设置堆内存</h3> <p>JVM 的内存设置是最重要的参数设置，也是 GC 分析和调优的重点。</p> <div class="custom-block tip"><p class="custom-block-title">特别注意</p> <p>JVM 总内存=堆+栈+非堆+堆外内存</p></div> <p>相关的参数：</p> <ul><li><code>-Xmx</code>, 指定最大堆内存。 如 <code>-Xmx4g</code>. 这只是限制了 Heap 部分的最大值为 4g。这个内存不包括栈内存，也不包括堆外使用的内存。</li> <li><code>-Xms</code>, 指定堆内存空间的初始大小。 如 <code>-Xms4g</code>。 而且指定的内存大小，并不是操作系统实际分配的初始值，而是 GC 先规划好，用到才分配。 专用服务器上需要保持 <code>-Xms</code>和<code>-Xmx</code>一致，否则应用刚启动可能就有好几个 FullGC。当两者配置不一致时，堆内存扩容可能会导致性能抖动。</li> <li><code>-Xmn</code>, 等价于 <code>-XX:NewSize</code>，使用 G1 垃圾收集器 <strong>不应该</strong> 设置该选项，在其他的某些业务场景下可以设置。官方建议设置为 <code>-Xmx</code> 的 <code>1/2 ~ 1/4</code>。</li> <li><code>-XX:MaxPermSize=size</code>, 这是 JDK1.7 之前使用的。Java8 默认允许的 Meta 空间无限大，此参数无效。</li> <li><code>-XX:MaxMetaspaceSize=size</code>, Java8 默认不限制 Meta 空间, 一般不允许设置该选项。</li> <li><code>XX:MaxDirectMemorySize=size</code>，系统可以使用的最大堆外内存，这个参数跟<code>-Dsun.nio.MaxDirectMemorySize</code>效果相同。</li> <li><code>-Xss</code>, 设置每个线程栈的字节数。 例如 <code>-Xss1m</code> 指定线程栈为 1MB，与<code>-XX:ThreadStackSize=1m</code>等价</li></ul> <p>这里要特别说一下堆外内存，也就是说不在堆上的内存，我们可以通过jconsole，jvisualvm 等工具查看。</p> <h3 id="配置多少-xmx-合适"><a href="#配置多少-xmx-合适" class="header-anchor">#</a> 配置多少 xmx 合适</h3> <p>推荐配置系统或容器里可用内存的 70-80% 最好。比如说系统有 8G 物理内存，系统自己可能会用掉一点，大概还有 7.5G 可以用，那么建议配置</p> <blockquote><p>-Xmx6g 说明：xmx : 7.5G*0.8 = 6G，如果知道系统里有明确使用堆外内存的地方，还需要进一步降低这个值。</p></blockquote> <h3 id="xmx-和-xms-是不是要配置成一致的"><a href="#xmx-和-xms-是不是要配置成一致的" class="header-anchor">#</a> xmx 和 xms 是不是要配置成一致的</h3> <p>一般情况下，我们的服务器是专用的，就是一个机器（也可能是云主机或 docker 容器）只部署一个 Java 应用，这样的时候建议配置成一样的，好处是不会再动态去分配，如果内存不足很容易被发现。</p> <h3 id="gc-日志相关的参数"><a href="#gc-日志相关的参数" class="header-anchor">#</a> GC 日志相关的参数</h3> <p>JVM 启动参数为我们提供了一些用于控制 GC 日志输出的选项。</p> <ul><li><code>-verbose:gc</code> ：和其他 GC 参数组合使用, 在 GC 日志中输出详细的GC信息。 包括每次 GC 前后各个内存池的大小，堆内存的大小，提升到老年代的大小，以及消耗的时间。此参数支持在运行过程中动态开关。比如使用 jcmd, jinfo， 以及使用 JMX 技术的其他客户端。</li> <li><code>-XX:+PrintGCDetails</code> 和 <code>-XX:+PrintGCTimeStamps</code>：打印 GC 细节与发生时间。请关注我们后续的 GC 课程章节。</li> <li><code>-Xloggc:file</code>：与<code>-verbose:gc</code>功能类似，只是将每次 GC 事件的相关情况记录到一个文件中，文件的位置最好在本地，以避免网络的潜在问题。若与 verbose:gc 命令同时出现在命令行中，则以 -Xloggc 为准。</li></ul> <p>示例:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms28g -Xmx28g -Xss1m \
-verbosegc -XX:+UseG1GC -XX:MaxGCPauseMillis=200 \
-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/usr/local/&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="jdk-内置命令行工具"><a href="#jdk-内置命令行工具" class="header-anchor">#</a> JDK 内置命令行工具</h2> <p>JDK 自带的工具和程序可以分为 2 大类型：</p> <ol><li>开发工具</li> <li>诊断分析工具</li></ol> <h3 id="jdk-内置的开发工具"><a href="#jdk-内置的开发工具" class="header-anchor">#</a> JDK 内置的开发工具</h3> <p>下面列举常用的部分：</p> <table><thead><tr><th style="text-align:left;">工具</th> <th style="text-align:left;">简介</th></tr></thead> <tbody><tr><td style="text-align:left;">java</td> <td style="text-align:left;">Java 应用的启动程序</td></tr> <tr><td style="text-align:left;">javac</td> <td style="text-align:left;">JDK 内置的编译工具</td></tr> <tr><td style="text-align:left;">javap</td> <td style="text-align:left;">反编译 class 文件的工具</td></tr> <tr><td style="text-align:left;">javadoc</td> <td style="text-align:left;">根据 Java 代码和标准注释，自动生成相关的 API 说明文档</td></tr> <tr><td style="text-align:left;">javah</td> <td style="text-align:left;">JNI 开发时，根据 Java 代码生成需要的 .h 文件。</td></tr> <tr><td style="text-align:left;">extcheck</td> <td style="text-align:left;">检查某个 jar 文件和运行时扩展 jar 有没有版本冲突，很少使用</td></tr> <tr><td style="text-align:left;">jdb</td> <td style="text-align:left;">Java Debugger 可以调试本地和远端程序，属于 JPDA 中的一个 Demo 实现，供其他调试器参考。开发时很少使用</td></tr> <tr><td style="text-align:left;">jdeps</td> <td style="text-align:left;">探测 class 或 jar 包需要的依赖</td></tr> <tr><td style="text-align:left;">jar</td> <td style="text-align:left;">打包工具，可以将文件和目录打包成为 .jar 文件；.jar 文件本质上就是 zip 文件，只是后缀不同。使用时按顺序对应好选项和参数即可。</td></tr> <tr><td style="text-align:left;">keytool</td> <td style="text-align:left;">安全证书和密钥的管理工具（支持生成、导入、导出等操作）</td></tr> <tr><td style="text-align:left;">jarsigner</td> <td style="text-align:left;">jar 文件签名和验证工具</td></tr> <tr><td style="text-align:left;">policytool</td> <td style="text-align:left;">实际上这是一款图形界面工具，管理本机的 Java 安全策略</td></tr></tbody></table> <h3 id="命令行诊断和分析工具"><a href="#命令行诊断和分析工具" class="header-anchor">#</a> 命令行诊断和分析工具</h3> <p>JDK 内置了各种命令行工具。</p> <h3 id="jps"><a href="#jps" class="header-anchor">#</a> jps</h3> <p>JPS，用于展示 Java 进程信息（列表）。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>jps -v

<span class="token comment"># output</span>
<span class="token number">15883</span> Jps -Dapplication.home<span class="token operator">=</span>/usr/local/jdk1.8.0_74 -Xms8m
<span class="token number">6446</span> Jstatd -Dapplication.home<span class="token operator">=</span>/usr/local/jdk1.8.0_74 -Xms8m
        -Djava.security.policy<span class="token operator">=</span>/etc/java/jstatd.all.policy
<span class="token number">32383</span> Bootstrap -Xmx4096m -XX:+UseG1GC -verbose:gc
        -XX:+PrintGCDateStamps -XX:+PrintGCDetails
        -Xloggc:/xxx-tomcat/logs/gc.log
        -Dcatalina.base<span class="token operator">=</span>/xxx-tomcat -Dcatalina.home<span class="token operator">=</span>/data/tomcat
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>输出的内容，其中最重要的信息是前面的进程 ID（PID）。知道 JVM 进程的 PID 之后，就可以使用其他工具来进行诊断了。</p> <h3 id="jstat"><a href="#jstat" class="header-anchor">#</a> jstat</h3> <p>jstat 用来监控 JVM 内置的各种统计信息，主要是内存和 GC 相关的信息。在没有其他监控工具的情况下， jstat 可以简单查看各个内存池和 GC 的信息，可用于判别是否是 GC 问题或者内存溢出。</p> <h3 id="jmap"><a href="#jmap" class="header-anchor">#</a> jmap</h3> <p>面试最常问的就是 jmap 工具了。jmap 主要用来 Dump 堆内存。当然也支持输出统计信息。</p> <p>官方推荐使用 JDK 8 自带的 jcmd 工具来取代 jmap，但是 jmap 深入人心，jcmd 可能暂时取代不了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 看堆内存统计信息</span>
jmap -heap <span class="token number">4524</span>

<span class="token comment"># Dump 堆内存</span>
jmap -dump:format<span class="token operator">=</span>b,file<span class="token operator">=</span><span class="token number">3826</span>.hprof <span class="token number">3826</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>导出完成后，dump 文件大约和堆内存一样大。可以想办法压缩并传输。分析 hprof 文件可以使用 jhat 或者 <a href="https://www.eclipse.org/mat/" target="_blank" rel="noopener noreferrer">mat<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 工具。</p> <h3 id="jcmd"><a href="#jcmd" class="header-anchor">#</a> jcmd</h3> <p>诊断工具：jcmd 是 JDK 8 推出的一款本地诊断工具，只支持连接本机上同一个用户空间下的 JVM 进程。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Dump 堆内存</span>
jcmd <span class="token number">11155</span> <span class="token builtin class-name">help</span> GC.heap_dump
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>jcmd 坑的地方在于，必须指定绝对路径，否则导出的 hprof 文件就以 JVM 所在的目录计算（因为是发命令交给 JVM 执行的）。</p> <h3 id="jstack"><a href="#jstack" class="header-anchor">#</a> jstack</h3> <p>命令行工具、诊断工具：jstack 工具可以打印出 Java 线程的调用栈信息（Stack Trace）。一般用来查看存在哪些线程，诊断是否存在死锁等。这时候就看出来给线程（池）命名的必要性了（开发不规范，整个项目都是坑），具体可参考阿里巴巴的 Java 开发规范。</p> <p>选项说明：</p> <ul><li><code>-F</code>：强制执行 Thread Dump，可在 Java 进程卡死（hung 住）时使用，此选项可能需要系统权限。</li> <li><code>-m</code>：混合模式（mixed mode），将 Java 帧和 native 帧一起输出，此选项可能需要系统权限。</li> <li><code>-l</code>：长列表模式，将线程相关的 locks 信息一起输出，比如持有的锁，等待的锁。</li></ul> <p>常用的选项是 <code>-l</code>，示例用法：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>jstack <span class="token number">4524</span>
jstack -l <span class="token number">4524</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>死锁的原因一般是锁定多个资源的顺序出了问题（交叉依赖）， 网上示例代码很多，比如搜索“Java 死锁 示例”。</p> <p>在 Linux 和 macOS 上，<code>jstack pid</code> 的效果跟 <code>kill -3 pid</code> 相同。</p> <h2 id="jdk-内置图形界面工具"><a href="#jdk-内置图形界面工具" class="header-anchor">#</a> JDK 内置图形界面工具</h2> <p>GUI 图形界面工具，主要是 3 款：JConsole、JVisualVM、JMC。其实这三个产品可以说是 3 代不同的 JVM 分析工具。</p> <p>这三个工具都支持我们分析本地 JVM 进程，或者通过 JMX 等方式连接到远程 JVM 进程。当然，图形界面工具的版本号和目标 JVM 不能差别太大，否则可能会报错。</p> <h3 id="jconsole"><a href="#jconsole" class="header-anchor">#</a> JConsole</h3> <p>JConsole，顾名思义，就是“Java 控制台”，在这里，我们可以从多个维度和时间范围去监控一个 Java 进程的内外部指标。进而通过这些指标数据来分析判断 JVM 的状态，为我们的调优提供依据。</p> <p>在 Windows 或 macOS 的运行窗口或命令行输入 <code>jconsole</code>，然后回车就可以打开。</p> <h3 id="jvisualvm"><a href="#jvisualvm" class="header-anchor">#</a> JVisualVM</h3> <p>在命令行或者运行窗口直接输入<code>jvisualvm</code>即可启动。</p> <p>JVisualVM 最强大的地方在于插件。最常用的插件是 VisualGC 和 MBeans。</p> <h3 id="jmc"><a href="#jmc" class="header-anchor">#</a> JMC</h3> <p>JMC 和 JVisualVM 功能类似，因为 JMC 的前身是 JRMC，JRMC 是 BEA 公司的 JRockit JDK 自带的分析工具，被 Oracle 收购以后，整合成了 JMC 工具。Oracle 试图用 JMC 来取代 JVisualVM，在商业环境使用 JFR 需要付费获取授权。</p> <p>在命令行输入<code>jmc</code>即可启动。</p> <h2 id="java-平台调试体系"><a href="#java-平台调试体系" class="header-anchor">#</a> Java 平台调试体系</h2> <p>Java 平台调试体系（Java Platform Debugger Architecture，JPDA），由三个相对独立的层次共同组成。这三个层次由低到高分别是 Java 虚拟机工具接口（JVMTI）、Java 调试连接协议（JDWP）以及 Java 调试接口（JDI）。详细介绍请参考或搜索：<a href="https://www.ibm.com/developerworks/cn/java/j-lo-jpda1/index.html" target="_blank" rel="noopener noreferrer">JPDA 体系概览<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="服务端-jvm-配置"><a href="#服务端-jvm-配置" class="header-anchor">#</a> 服务端 JVM 配置</h3> <p>本篇主要讲解如何在 JVM 中启用 JDWP，以供远程调试。假设主启动类是 com.xxx.Test。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>java -Xdebug -Xrunjdwp:transport<span class="token operator">=</span>dt_socket,address<span class="token operator">=</span><span class="token number">8788</span>,server<span class="token operator">=</span>y,suspend<span class="token operator">=</span>n com.xxx.Test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>-Xdebug</code> 这个选项什么用都没有，官方说是为了历史兼容性，避免报错才没有删除。</p> <p>参数配置里的 <code>suspend=y</code> 会让 Java 进程启动时先挂起，等到有调试器连接上以后继续执行程序。</p> <p>而如果改成 <code>suspend=n</code> 的话，则此 Java 进程会直接执行，但是我们可以随时通过调试器连上进程。</p> <p>就是说，比如说我们启动一个 Web 服务器进程，当这个值是 y 的时候，服务器的 JVM 初始化以后不会启动 Web 服务器，会一直等到我们用 IDEA 或 Eclipse、JDB 等工具连上这个 Java 进程后，再继续启动 Web 服务器。而如果是 n 的话，则会不管有没有调试器连接，都会正常运行。</p> <blockquote><p>如果细心观察的话，会发现 IDEA 中 Debug 模式启动的程序，自动设置了类似的启动选项。</p></blockquote> <h3 id="jdb"><a href="#jdb" class="header-anchor">#</a> JDB</h3> <p>启用了 JDWP 之后，可以使用各种客户端来进行调试/远程调试。比如 JDB 调试本地 JVM：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>jdb -attach <span class="token string">'debug'</span>
jdb -attach <span class="token number">8888</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当 JDB 初始化并连接到 Test 之后，就可以进行 Java 代码级（Java-level）的调试。</p> <p>但是 JDB 调试非常麻烦，我们一般还是在开发工具 IDE（IDEA、Eclipse）里调试代码。</p> <details class="custom-block details"><summary>JDB常用的命令</summary> <ol><li>设置断点：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>stop at 类名:行号 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>清除断点：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>clear at 类名:行号 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>显示局部变量：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>localx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>显示变量 a 的值：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>print a
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="5"><li>显示当前线程堆栈：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>wherei
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="6"><li>代码执行到下一行：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>next
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="7"><li>代码继续执行，直到遇到下一个断点：</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>cont
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></details> <h3 id="idea-中使用远程调试"><a href="#idea-中使用远程调试" class="header-anchor">#</a> IDEA 中使用远程调试</h3> <p>在Run/Debug Configurations里添加Remote，设置host的debug端口号，点击Apply。</p> <p><img src="https://buxianshan.oss-cn-beijing.aliyuncs.com/Typora_images/image-20220320143445868.png" alt="image-20220320143445868"></p> <p>点击 Debug 的那个按钮即可启动远程调试，连上之后就和调试本地程序一样了。当然，记得加断点或者条件断点。</p> <div class="custom-block warning"><p class="custom-block-title">特别注意</p> <p>远程调试时，需要保证服务端 JVM 中运行的代码和本地完全一致，否则可能会有莫名其妙的问题。</p></div> <p>细心的同学可能已经发现，IDEA 给出了远程 JVM 的启动参数，建议使用 agentlib 的方式：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-agentlib:jdwp<span class="token operator">=</span>transport<span class="token operator">=</span>dt_socket,server<span class="token operator">=</span>y,suspend<span class="token operator">=</span>n,address<span class="token operator">=</span><span class="token number">30216</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>JVM 为什么可以让不同的开发工具和调试器都连接上进行调试呢？因为它提供了一套公开的调试信息的交互协议，各家厂商就可以根据这个协议去实现自己的调试图形工具，进而方便 Java 开发人员的使用。</p> <h3 id="jdwp-协议规范"><a href="#jdwp-协议规范" class="header-anchor">#</a> JDWP 协议规范</h3> <p>JDWP 全称是 Java Debug Wire Protocol，中文翻译为“Java 调试连接协议”，是用于规范调试器（Debugger）与目标 JVM 之间通信的协议。</p> <p>JDWP 支持两种调试场景：</p> <ul><li>同一台计算机上的其他进程</li> <li>远程计算机上</li></ul> <p>与许多协议规范的不同之处在于，JDWP 只规定了具体的格式和布局，而不管你用什么协议来传输数据。</p> <h2 id="jmx-与相关工具"><a href="#jmx-与相关工具" class="header-anchor">#</a> JMX 与相关工具</h2> <p>Java 平台提供了全面的 JVM 监控和管理措施。</p> <p>Java SE 5.0 版本引入了 JMX 技术（Java Management Extensions，Java 管理扩展），是用于监控和管理 JVM 资源（包括应用程序、设备、服务和 JVM）的一组标准 API。</p> <p>最常见的 JMX 客户端是 JConsole 和 JVisualVM（可以安装各种插件，十分强大）。两个工具都是标准 JDK 的一部分，而且很容易使用. 如果使用的是 JDK 7u40 及更高版本，还可以使用另一个工具：Java Mission Control（JMC，大致翻译为 Java 控制中心）。</p> <h2 id="未完待续"><a href="#未完待续" class="header-anchor">#</a> 未完待续……</h2></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/buxianshan/bxs-blog/edit/master/docs/java/jvm.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2023-01-17 14:04:34</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/bxs-blog/assets/js/app.7578192e.js" defer></script><script src="/bxs-blog/assets/js/2.573d8f00.js" defer></script><script src="/bxs-blog/assets/js/43.a2766d86.js" defer></script><script src="/bxs-blog/assets/js/10.5b9464ff.js" defer></script>
  </body>
</html>
